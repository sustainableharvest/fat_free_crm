- entity_name = controller.controller_name.singularize.underscore
- @entity = instance_variable_get("@#{entity_name}")
- create_id = "create_#{entity_name}"

- if @entity.valid?
  $('##{create_id}_arrow').html(crm.COLLAPSED);
  / $('##{create_id}_title').html('#{ j render(:partial => entity_name, :collection => [ @entity ]) }');
  $('##{create_id}').slideUp(250);
  $('##{entity_name.pluralize}').prepend('#{ j render(:partial => entity_name, :collection => [ @entity ]) }');

  - if called_from_index_page?
    = refresh_sidebar(:index, :fitlers)
  - else
    - @opportunity.reload
    = refresh_sidebar_for(:opportunities, :show, :summary)
  crm.flick('empty', 'remove');
- else
  $('##{create_id}').html('#{ j render(:partial => "new") }');